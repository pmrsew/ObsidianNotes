# Asynchronous React
#api #asynchronous #react #graphql

## Fetching data with Hooks and Displaying data from an API
Steps to fetch data from external API:
1. fetch data using both `useState()` and `useEffect()` in combination
2. pass properties from object generated by JSON to component
3. pull from the data points needed so that data is displayed

```
import { useState, useEffect } from "react";

//STEP 3
function GithubUser({name, location, avatar}){
  return (
    <div>
      <h1>{name}</h1>
      <p>{location}</p>
      <img src={avatar} height={150} alt="Github user's, pmrsew, avatar"/>
    </div>
  );
}

function App() {
  //STEP 1
  const [data, setData] = useState(null);
  useEffect(() => {
    fetch(`https://api.github.com/users/pmrsew`)
      .then((response) => response.json())
      .then(setData);
  }, []);

  //STEP 2
  if (data) return (
    <GithubUser name={data.name} location={data.location} avatar={data.avatar_url} />
  );

  return <h1>Data</h1>;
}
```

Step One in more detail:
```
//useState to handle data
//useEffect to call for external data
import { useState, useEffect } from "react";

function App() {
  //create data container and function to set the data
  const[data, setData] = useState(null);

  useEffect(() => {
    //fetch() is built in and supported by browser
    //provides a way to make an HTTP request for data
    //once data is fetched, take response and turn it into JSON
    //once data is turned into Json, set it to data container
    fetch(`https://api.github.com/users/pmrsew`).then((response) => response.json()).then(setData);
  }, []) //empty array so api is only called on ONCE

  //check for data and return if exists using pre tag
  //pre tag is a preformatted tag for JSON
  if(data) return (<pre>{JSON.stringify(data, null,2)}</pre>);

  //return if no data is found
  return (
    <h1>Data</h1>
  );
}
```

## Handling loading states
- When fetching data from external API, possible states it can be in include:
	- Loading state, fetching but not back yet
	- Success state, data has been fetched from api
	- Error state, data couldn't load
- States can be handled with `useState()`
- If an asynchronous request is being made, loading needs to be handled
```
import { useState, useEffect } from "react";

function GithubUser({ name, location, avatar }) {
  return (
    <div>
      <h1>{name}</h1>
      <p>{location}</p>
      <img src={avatar} height={150} alt={name} />
    </div>
  );
}

function App() {
  const [data, setData] = useState(null);

  //handling state of API data
  const[error, setError] = useState(null);
  const[loading, setLoading] = useState(null);
  
  //handle loading at beginning and end of fetch
  //.catch can be used to catch errors within the chain
  useEffect(() => {
    setLoading(true);
    fetch(`https://api.github.com/users/moonhighway`)
      .then((response) => response.json())
      .then(setData)
      .then(() => setLoading(false))
      .catch(setError);
  }, []);

  //what webpage is displaying based on state of data
  if(loading) return <h1>Loading...</h1>;
  if(error) return <pre>{JSON.stringify(error)}</pre>;
  if(!data) return null;

  return (
    <GithubUser
      name={data.name}
      location={data.location}
      avatar={data.avatar_url}
    />
  );
}
```

## Fetching data with GraphQL
- GraphQL: a way of creating an API where you can specify what data you want by using its field

```
import { useState, useEffect } from "react";

//query body used in request
const query = `
query{
  allLifts{
    name
    elevationGain
    status
  }
}
`; 

//request options and body
const opts = {
  method: "POST",
  headers: {"Content-Type":"application/json"},
  body: JSON.stringify({query})
};

//function creates lift component for each row of data retrieved
function Lift({ name, elevationGain, status }) {
  return (
    <div>
      <h1>{name}</h1>
      <p>{elevationGain} {status}</p>
    </div>
  );
}

function App() {
  const [data, setData] = useState(null);
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  //website goes to a GraphQL Playground used to send requests for data
  useEffect(() => {
    setLoading(true);
    //pass into fetch() address AND request
    fetch(
      `https://snowtooth.moonhighway.com`,
      opts
    )
      .then((response) => response.json())
      .then(setData)
      .then(() => setLoading(false))
      .catch(setError);
  }, []);

  if (loading) return <h1>Loading...</h1>;
  if (error)
    return <pre>{JSON.stringify(error)}</pre>;
  if (!data) return null;

  //iterate over data and create Lift components with passed in properties
  return (
    <div>
      {data.data.allLifts.map((lift) => (
        <Lift
          name={lift.name}
          elevationGain={lift.elevationGain}
          status={lift.status}
        />
      ))}
    </div>
  );
}
```

## Working with render props
- A way to display data while handling data loading

```
//array of data to display
const tahoe_peaks = [
  {name: "Freel", elevation: 10891},
  {name: "Monument", elevation: 10067},
  {name: "Pyramid", elevation: 9983},
  {name: "Tallac", elevation: 9735}
];

//function that takes in:
//  data array
//  function to help render an individual list item
//  what will be displayed if array is empty
//returns data as unordered list unless empty
function List({data, renderItem, renderEmpty}){
  return !data.length ? renderEmpty:(
    <ul>
      {data.map((item) => (
        <li key={item.name}>{renderItem(item)}</li>
      ))}
    </ul>
  );
}

function App() {
  //calling on List function and passing in required arguments
  return (
    <List
      data={tahoe_peaks}
      renderEmpty={<p>This list is empty</p>}
      renderItem={(item) => (
        <>
          {item.name} - {item.elevation} ft.
        </>
      )}
    />
  );
}
```